<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –æ—Ç—á—ë—Ç—ã –ø–æ —É—á–µ–Ω–∏–∫–∞–º - –î–µ–º–æ</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background-color: #2196F3;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        
        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .dashboard {
            display: none;
        }
        
        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-success {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-warning {
            background-color: #FF9800;
            color: white;
        }
        
        .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        .student-list {
            display: grid;
            gap: 1rem;
        }
        
        .student-card {
            background: white;
            padding: 1rem;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .student-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .student-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 0 0 0.5rem 0;
        }
        
        .student-group {
            color: #666;
            margin: 0;
            font-size: 0.9rem;
        }
        
        .student-notes {
            color: #888;
            font-size: 0.85rem;
            margin: 0.25rem 0 0 0;
            font-style: italic;
        }
        
        .grade-form {
            display: grid;
            gap: 1rem;
        }
        
        .criteria-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .total-score {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .success {
            color: #2e7d32;
            background: #e8f5e8;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header" id="header" style="display: none;">
        <h1 style="margin: 0;">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –æ—Ç—á—ë—Ç—ã –ø–æ —É—á–µ–Ω–∏–∫–∞–º</h1>
        <div>
            <span id="userName"></span>
            <button class="btn btn-primary" onclick="logout()" style="margin-left: 1rem;">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-form">
            <h2 style="text-align: center; margin-bottom: 2rem;">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
            
            <div id="loginError" class="error hidden"></div>
            
            <input type="email" id="email" class="input" placeholder="Email" value="teacher@demo.com">
            <input type="password" id="password" class="input" placeholder="–ü–∞—Ä–æ–ª—å" value="demo123">
            
            <button class="btn btn-primary" onclick="login()" style="width: 100%;">–í–æ–π—Ç–∏</button>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: #e3f2fd; border-radius: 4px; font-size: 0.875rem;">
                <strong>–î–µ–º–æ –¥–∞–Ω–Ω—ã–µ:</strong><br>
                Email: teacher@demo.com<br>
                –ü–∞—Ä–æ–ª—å: demo123
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="margin: 0;">–î–∞—à–±–æ—Ä–¥</h2>
                <button class="btn btn-success" onclick="showAddStudent()">–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
            </div>

            <div class="grid-2">
                <!-- Students List -->
                <div>
                    <h3>–°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤</h3>
                    <div id="studentsList" class="student-list">
                        <!-- Students will be loaded here -->
                    </div>
                </div>

                <!-- Student Details -->
                <div>
                    <div id="studentDetails" class="hidden">
                        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–µ–Ω–∏–∫–µ</h3>
                        <div class="card" id="studentInfo">
                            <!-- Student info will be shown here -->
                        </div>
                        <button class="btn btn-warning" onclick="showGradeEntry()" style="width: 100%;">–í—ã—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 2rem; border-radius: 8px; width: 100%; max-width: 500px;">
            <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</h3>
            <div id="addStudentError" class="error hidden"></div>
            <div style="margin-bottom: 0.5rem;">
                <label style="display: block; margin-bottom: 0.25rem; font-weight: bold;">–§–ò–û —É—á–µ–Ω–∏–∫–∞ *</label>
                <input type="text" id="newStudentName" class="input" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á)" style="border: 2px solid #ddd;">
                <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                    –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –§–ò–û —É—á–µ–Ω–∏–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ
                </div>
            </div>
            <input type="text" id="newStudentGroup" class="input" placeholder="–ì—Ä—É–ø–ø–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: A1 Mon 18:00)">
            <textarea id="newStudentNotes" class="input" placeholder="–ó–∞–º–µ—Ç–∫–∏" rows="3"></textarea>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn" onclick="hideAddStudent()" style="background: #f5f5f5;">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-success" onclick="addStudent()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Grade Entry Modal -->
    <div id="gradeModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 2rem; border-radius: 8px; width: 100%; max-width: 800px; max-height: 90vh; overflow: auto;">
            <h3 id="gradeModalTitle">–û—Ü–µ–Ω–∫–∏</h3>
            <div id="gradeError" class="error hidden"></div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <select id="yearSelect" class="input">
                    <option value="2024/2025">2024/2025</option>
                </select>
                <select id="monthSelect" class="input">
                    <option value="–°–µ–Ω—Ç—è–±—Ä—å">–°–µ–Ω—Ç—è–±—Ä—å</option>
                    <option value="–û–∫—Ç—è–±—Ä—å">–û–∫—Ç—è–±—Ä—å</option>
                    <option value="–ù–æ—è–±—Ä—å">–ù–æ—è–±—Ä—å</option>
                    <option value="–î–µ–∫–∞–±—Ä—å">–î–µ–∫–∞–±—Ä—å</option>
                    <option value="–Ø–Ω–≤–∞—Ä—å">–Ø–Ω–≤–∞—Ä—å</option>
                    <option value="–§–µ–≤—Ä–∞–ª—å">–§–µ–≤—Ä–∞–ª—å</option>
                    <option value="–ú–∞—Ä—Ç">–ú–∞—Ä—Ç</option>
                    <option value="–ê–ø—Ä–µ–ª—å">–ê–ø—Ä–µ–ª—å</option>
                    <option value="–ú–∞–π">–ú–∞–π</option>
                    <option value="–ò—é–Ω—å">–ò—é–Ω—å</option>
                </select>
            </div>

            <h4>–ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏</h4>
            <div id="criteriaList" class="grade-form">
                <!-- Criteria will be loaded here -->
            </div>

            <div class="total-score" id="totalScore">
                –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: 0 (F)
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0;">
                <input type="number" id="attendance" class="input" placeholder="–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å (%)" min="0" max="100">
                <input type="text" id="homework" class="input" placeholder="–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ">
            </div>

            <div style="display: grid; gap: 1rem; margin: 1.5rem 0;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea id="comment" class="input" placeholder="–û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ —É—á–µ–Ω–∏–∫–∞..." rows="3"></textarea>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</label>
                    <textarea id="recommendations" class="input" placeholder="–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è..." rows="3"></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn" onclick="hideGradeEntry()" style="background: #f5f5f5;">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-success" onclick="saveGrade()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let currentUser = null;
        let currentStudent = null;
        let students = [];
        let criteria = [
            { id: '1', name: 'üé≠ –î—Ä–∞–º–∞—Ç–∏–∫–∞ / –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ', weight: 0.25, scale: '1-4' },
            { id: '2', name: 'üó£ –ì–æ–≤–æ—Ä–µ–Ω–∏–µ / –æ–±—â–µ–Ω–∏–µ', weight: 0.25, scale: '1-4' },
            { id: '3', name: 'üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ', weight: 0.25, scale: '1-4' },
            { id: '4', name: 'üöÄ –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', weight: 0.25, scale: '1-4' }
        ];

        // Auth functions
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    localStorage.setItem('token', data.token);
                    showDashboard();
                } else {
                    const error = await response.json();
                    showError('loginError', error.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                }
            } catch (err) {
                showError('loginError', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ localhost:3001');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('token');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('header').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('header').style.display = 'flex';
            document.getElementById('userName').textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUser.fullName}`;
            loadStudents();
        }

        // Student functions
        async function loadStudents() {
            try {
                const response = await fetch(`${API_BASE}/students`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok) {
                    students = await response.json();
                    renderStudents();
                } else {
                    console.error('Failed to load students');
                    // Show demo data if API fails
                    students = [
                        { id: '1', fullName: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á', group: 'A1 Mon 18:00', notes: '–ê–∫—Ç–∏–≤–Ω—ã–π —É—á–µ–Ω–∏–∫' },
                        { id: '2', fullName: '–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è –°–µ—Ä–≥–µ–µ–≤–Ω–∞', group: 'B1 Wed 19:00', notes: '–•–æ—Ä–æ—à–µ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ' }
                    ];
                    renderStudents();
                }
            } catch (err) {
                console.error('Error loading students:', err);
                // Show demo data
                students = [
                    { id: '1', fullName: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á', group: 'A1 Mon 18:00', notes: '–ê–∫—Ç–∏–≤–Ω—ã–π —É—á–µ–Ω–∏–∫' },
                    { id: '2', fullName: '–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è –°–µ—Ä–≥–µ–µ–≤–Ω–∞', group: 'B1 Wed 19:00', notes: '–•–æ—Ä–æ—à–µ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ' }
                ];
                renderStudents();
            }
        }

        function renderStudents() {
            const container = document.getElementById('studentsList');
            container.innerHTML = students.map(student => `
                <div class="student-card" onclick="selectStudent('${student.id}')">
                    <div class="student-name">${student.fullName}</div>
                    <div class="student-group">–ì—Ä—É–ø–ø–∞: ${student.group}</div>
                    ${student.notes ? `<div class="student-notes">${student.notes}</div>` : ''}
                </div>
            `).join('');
        }

        function selectStudent(studentId) {
            currentStudent = students.find(s => s.id === studentId);
            if (currentStudent) {
                document.getElementById('studentDetails').classList.remove('hidden');
                document.getElementById('studentInfo').innerHTML = `
                    <p><strong>–ò–º—è:</strong> ${currentStudent.fullName}</p>
                    <p><strong>–ì—Ä—É–ø–ø–∞:</strong> ${currentStudent.group}</p>
                    ${currentStudent.notes ? `<p><strong>–ó–∞–º–µ—Ç–∫–∏:</strong> ${currentStudent.notes}</p>` : ''}
                `;
            }
        }

        // Modal functions
        function showAddStudent() {
            document.getElementById('addStudentModal').classList.remove('hidden');
        }

        function hideAddStudent() {
            document.getElementById('addStudentModal').classList.add('hidden');
            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentGroup').value = '';
            document.getElementById('newStudentNotes').value = '';
        }

        function validateFullName(name) {
            const nameParts = name.trim().split(/\s+/);
            return nameParts.length >= 2 && nameParts.every(part => part.length > 0);
        }

        async function addStudent() {
            const name = document.getElementById('newStudentName').value;
            const group = document.getElementById('newStudentGroup').value;
            const notes = document.getElementById('newStudentNotes').value;

            if (!name || !group) {
                showError('addStudentError', '–§–ò–û –∏ –≥—Ä—É–ø–ø–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
                return;
            }

            if (!validateFullName(name)) {
                showError('addStudentError', '–§–ò–û –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/students`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ fullName: name, group, notes })
                });

                if (response.ok) {
                    const student = await response.json();
                    students.push(student);
                    renderStudents();
                    hideAddStudent();
                    showSuccess('–£—á–µ–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                } else {
                    const error = await response.json();
                    showError('addStudentError', error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞');
                }
            } catch (err) {
                // Demo mode - add to local array
                const newStudent = {
                    id: Date.now().toString(),
                    fullName: name,
                    group,
                    notes
                };
                students.push(newStudent);
                renderStudents();
                hideAddStudent();
                showSuccess('–£—á–µ–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω (–¥–µ–º–æ —Ä–µ–∂–∏–º)');
            }
        }

        function showGradeEntry() {
            if (!currentStudent) return;
            
            document.getElementById('gradeModal').classList.remove('hidden');
            document.getElementById('gradeModalTitle').textContent = `–û—Ü–µ–Ω–∫–∏ –¥–ª—è ${currentStudent.fullName}`;
            
            // Render criteria with level descriptions
            const levelDescriptions = {
                '1': {
                    'üé≠ –î—Ä–∞–º–∞—Ç–∏–∫–∞ / –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ': '–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏, —Ä–µ—á—å –Ω–µ—Ä–∞–∑–±–æ—Ä—á–∏–≤–∞',
                    'üó£ –ì–æ–≤–æ—Ä–µ–Ω–∏–µ / –æ–±—â–µ–Ω–∏–µ': '–û—Ç–≤–µ—á–∞–µ—Ç –æ–¥–Ω–æ—Å–ª–æ–∂–Ω–æ –∏–ª–∏ –º–æ–ª—á–∏—Ç',
                    'üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ': '–ù–µ –¥–µ–ª–∞–µ—Ç',
                    'üöÄ –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': '–ß–∞—Å—Ç–æ –æ—Ç–≤–ª–µ–∫–∞–µ—Ç—Å—è, –ø–∞—Å—Å–∏–≤–µ–Ω'
                },
                '2': {
                    'üé≠ –î—Ä–∞–º–∞—Ç–∏–∫–∞ / –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ': '–ò–Ω–æ–≥–¥–∞ –ø–æ–Ω—è—Ç–Ω–∞, –º–Ω–æ–≥–æ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–µ–π',
                    'üó£ –ì–æ–≤–æ—Ä–µ–Ω–∏–µ / –æ–±—â–µ–Ω–∏–µ': '–û—Ç–≤–µ—á–∞–µ—Ç —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π',
                    'üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ': '–î–µ–ª–∞–µ—Ç —Ä–µ–¥–∫–æ/—á–∞—Å—Ç–∏—á–Ω–æ',
                    'üöÄ –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': '–ò–Ω–æ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è'
                },
                '3': {
                    'üé≠ –î—Ä–∞–º–∞—Ç–∏–∫–∞ / –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ': '–ü–æ–Ω—è—Ç–Ω–∞—è —Ä–µ—á—å, –Ω–µ–±–æ–ª—å—à–∏–µ –æ—à–∏–±–∫–∏',
                    'üó£ –ì–æ–≤–æ—Ä–µ–Ω–∏–µ / –æ–±—â–µ–Ω–∏–µ': '–ê–∫—Ç–∏–≤–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç, –∏–Ω–æ–≥–¥–∞ –æ—à–∏–±–∞–µ—Ç—Å—è',
                    'üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ': '–î–µ–ª–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ, –Ω–æ —Å –æ—à–∏–±–∫–∞–º–∏',
                    'üöÄ –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': '–í–æ–≤–ª–µ—á—ë–Ω, –∞–∫—Ç–∏–≤–Ω–æ —É—á–∞—Å—Ç–≤—É–µ—Ç'
                },
                '4': {
                    'üé≠ –î—Ä–∞–º–∞—Ç–∏–∫–∞ / –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ': '–ß–∏—Å—Ç–æ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ, –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–∞—è —Ä–µ—á—å',
                    'üó£ –ì–æ–≤–æ—Ä–µ–Ω–∏–µ / –æ–±—â–µ–Ω–∏–µ': '–ì–æ–≤–æ—Ä–∏—Ç —Å–≤–æ–±–æ–¥–Ω–æ, –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –¥–∏–∞–ª–æ–≥',
                    'üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ': '–î–µ–ª–∞–µ—Ç –≤—Å–µ–≥–¥–∞, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ',
                    'üöÄ –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': '–í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á—ë–Ω, –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –∏ —ç–Ω–µ—Ä–≥–∏—è'
                }
            };

            const container = document.getElementById('criteriaList');
            container.innerHTML = criteria.map(criterion => `
                <div style="background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: grid; grid-template-columns: 2fr 100px; gap: 1rem; align-items: center; margin-bottom: 0.5rem;">
                        <div>
                            <strong style="font-size: 1.1rem;">${criterion.name}</strong>
                            <div style="font-size: 0.875rem; color: #666;">
                                –í–µ—Å: ${criterion.weight} | –®–∫–∞–ª–∞: ${criterion.scale}
                            </div>
                        </div>
                        <select id="grade_${criterion.id}" onchange="calculateTotal(); updateDescription('${criterion.id}', '${criterion.name}')" 
                                style="padding: 0.75rem; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem; text-align: center;">
                            <option value="1">1 - –ù–∏–∑–∫–∏–π</option>
                            <option value="2">2 - –°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="3">3 - –•–æ—Ä–æ—à–∏–π</option>
                            <option value="4">4 - –û—Ç–ª–∏—á–Ω—ã–π</option>
                        </select>
                    </div>
                    <div id="description_${criterion.id}" style="font-size: 0.875rem; color: #555; font-style: italic; min-height: 1.2rem;">
                        ${levelDescriptions['1'][criterion.name]}
                    </div>
                </div>
            `).join('');
            
            calculateTotal();
        }

        function hideGradeEntry() {
            document.getElementById('gradeModal').classList.add('hidden');
        }

        function updateDescription(criterionId, criterionName) {
            const gradeSelect = document.getElementById(`grade_${criterionId}`);
            const descriptionDiv = document.getElementById(`description_${criterionId}`);
            
            if (gradeSelect && descriptionDiv) {
                const level = gradeSelect.value;
                const levelDescriptions = {
                    '1': {
                        'üé≠ –î—Ä–∞–º–∞—Ç–∏–∫–∞ / –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ': '–ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏, —Ä–µ—á—å –Ω–µ—Ä–∞–∑–±–æ—Ä—á–∏–≤–∞',
                        'üó£ –ì–æ–≤–æ—Ä–µ–Ω–∏–µ / –æ–±—â–µ–Ω–∏–µ': '–û—Ç–≤–µ—á–∞–µ—Ç –æ–¥–Ω–æ—Å–ª–æ–∂–Ω–æ –∏–ª–∏ –º–æ–ª—á–∏—Ç',
                        'üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ': '–ù–µ –¥–µ–ª–∞–µ—Ç',
                        'üöÄ –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': '–ß–∞—Å—Ç–æ –æ—Ç–≤–ª–µ–∫–∞–µ—Ç—Å—è, –ø–∞—Å—Å–∏–≤–µ–Ω'
                    },
                    '2': {
                        'üé≠ –î—Ä–∞–º–∞—Ç–∏–∫–∞ / –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ': '–ò–Ω–æ–≥–¥–∞ –ø–æ–Ω—è—Ç–Ω–∞, –º–Ω–æ–≥–æ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–µ–π',
                        'üó£ –ì–æ–≤–æ—Ä–µ–Ω–∏–µ / –æ–±—â–µ–Ω–∏–µ': '–û—Ç–≤–µ—á–∞–µ—Ç —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π',
                        'üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ': '–î–µ–ª–∞–µ—Ç —Ä–µ–¥–∫–æ/—á–∞—Å—Ç–∏—á–Ω–æ',
                        'üöÄ –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': '–ò–Ω–æ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è'
                    },
                    '3': {
                        'üé≠ –î—Ä–∞–º–∞—Ç–∏–∫–∞ / –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ': '–ü–æ–Ω—è—Ç–Ω–∞—è —Ä–µ—á—å, –Ω–µ–±–æ–ª—å—à–∏–µ –æ—à–∏–±–∫–∏',
                        'üó£ –ì–æ–≤–æ—Ä–µ–Ω–∏–µ / –æ–±—â–µ–Ω–∏–µ': '–ê–∫—Ç–∏–≤–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç, –∏–Ω–æ–≥–¥–∞ –æ—à–∏–±–∞–µ—Ç—Å—è',
                        'üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ': '–î–µ–ª–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ, –Ω–æ —Å –æ—à–∏–±–∫–∞–º–∏',
                        'üöÄ –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': '–í–æ–≤–ª–µ—á—ë–Ω, –∞–∫—Ç–∏–≤–Ω–æ —É—á–∞—Å—Ç–≤—É–µ—Ç'
                    },
                    '4': {
                        'üé≠ –î—Ä–∞–º–∞—Ç–∏–∫–∞ / –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ': '–ß–∏—Å—Ç–æ–µ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ, –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–∞—è —Ä–µ—á—å',
                        'üó£ –ì–æ–≤–æ—Ä–µ–Ω–∏–µ / –æ–±—â–µ–Ω–∏–µ': '–ì–æ–≤–æ—Ä–∏—Ç —Å–≤–æ–±–æ–¥–Ω–æ, –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –¥–∏–∞–ª–æ–≥',
                        'üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ': '–î–µ–ª–∞–µ—Ç –≤—Å–µ–≥–¥–∞, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ',
                        'üöÄ –í–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å': '–í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á—ë–Ω, –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –∏ —ç–Ω–µ—Ä–≥–∏—è'
                    }
                };
                
                descriptionDiv.textContent = levelDescriptions[level][criterionName] || '';
            }
        }

        function calculateTotal() {
            let total = 0;
            let totalWeight = 0;

            criteria.forEach(criterion => {
                const gradeSelect = document.getElementById(`grade_${criterion.id}`);
                
                if (gradeSelect) {
                    const grade = parseFloat(gradeSelect.value) || 1;
                    total += grade * criterion.weight;
                    totalWeight += criterion.weight;
                }
            });

            const finalScore = totalWeight > 0 ? total / totalWeight : 1;
            let letter = 'F';
            
            // Adjusted for 1-4 scale
            if (finalScore >= 3.5) letter = 'A (–û—Ç–ª–∏—á–Ω–æ)';
            else if (finalScore >= 2.5) letter = 'B (–•–æ—Ä–æ—à–æ)';
            else if (finalScore >= 1.5) letter = 'C (–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ)';
            else letter = 'D (–ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ)';

            document.getElementById('totalScore').textContent = `–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: ${finalScore.toFixed(2)} –∏–∑ 4 (${letter})`;
        }

        async function saveGrade() {
            if (!currentStudent) return;

            const gradeData = {
                studentId: currentStudent.id,
                yearId: '1', // Demo year ID
                month: document.getElementById('monthSelect').value,
                criteria: criteria.map(criterion => ({
                    criterionId: criterion.id,
                    value: parseFloat(document.getElementById(`grade_${criterion.id}`).value) || 1
                })),
                attendance: document.getElementById('attendance').value ? parseFloat(document.getElementById('attendance').value) : undefined,
                homework: document.getElementById('homework').value || undefined,
                comment: document.getElementById('comment').value || undefined,
                recommendations: document.getElementById('recommendations').value || undefined
            };

            try {
                const response = await fetch(`${API_BASE}/grades`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(gradeData)
                });

                if (response.ok) {
                    hideGradeEntry();
                    showSuccess('–û—Ü–µ–Ω–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                } else {
                    const error = await response.json();
                    showError('gradeError', error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ü–µ–Ω–æ–∫');
                }
            } catch (err) {
                hideGradeEntry();
                showSuccess('–û—Ü–µ–Ω–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–¥–µ–º–æ —Ä–µ–∂–∏–º)');
            }
        }

        // Utility functions
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '2000';
            successDiv.style.padding = '1rem';
            successDiv.style.borderRadius = '4px';
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                document.body.removeChild(successDiv);
            }, 3000);
        }

        // Initialize
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            if (token) {
                // Auto-login if token exists (simplified for demo)
                currentUser = { fullName: 'Demo User', email: 'teacher@demo.com' };
                showDashboard();
            }
        });
    </script>
</body>
</html>